<%= render "shared/header" %>

<div class="content">
  <p class="mt-4">
    <%= link_to "← Dashboard", dashboard_path, class: "view-link" %>
  </p>

  <h1>
    <% if @job.is_a?(PrintJob) %>
      Print Request
    <% else %>
      Scan Request
    <% end %>
    #<%= @job.id %>
  </h1>

  <p><strong>Status:</strong> <%= @job.status.humanize %></p>
  <p><strong>Submitted:</strong>
    <%= @job.created_at.strftime("%b %-d, %Y %l:%M %p") %>
  </p>

  <% if @job.is_a?(PrintJob) %>
    <!-- Print-job only fields -->
    <% if @job.model_file.attached? %>
      <p>
        <strong>Model file:</strong>
        <%= link_to @job.model_file.filename.to_s,
                    rails_blob_path(@job.model_file, disposition: "attachment") %>
      </p>
    <% elsif @job.url.present? %>
      <p>
        <strong>Model URL:</strong>
        <%= link_to @job.url, @job.url, target: "_blank", rel: "noopener" %>
      </p>
    <% end %>

    <p>
      <strong>Filament color:</strong>
      <%= @job.filament_color.presence || "—" %>
    </p>

  <% else %>
    <!-- Scan-job only fields -->
    <% if @job.scan_images.attached? %>
      <div class="mb-3">
        <strong>Submitted Photos:</strong><br>
        <% @job.scan_images.each do |img| %>
          <%= link_to url_for(img), target: "_blank" do %>
            <%= image_tag img.variant(resize_to_limit: [250, 250]), class: "img-thumbnail me-2 mb-2" %>
          <% end %>
        <% end %>
      </div>
    <% end %>

    <p>
      <strong>Spray OK:</strong>
      <%= @job.spray_ok? ? "Yes" : "No" %>
    </p>
  <% end %>

  <p>
    <strong>Pickup location:</strong>
    <% if (loc = PickupLocation.find_by(code: @job.pickup_location)) %>
      <%= loc.name %>
    <% else %>
      <%= @job.pickup_location.humanize %>
    <% end %>
  </p>

  <% if @job.respond_to?(:assigned_printer) && @job.assigned_printer %>
    <p>
      <strong>Assigned printer:</strong>
      <%= @job.assigned_printer.printer_model %>
    </p>
  <% end %>

  <% if @messages.any? %>
    <h2 class="mt-4">Messages</h2>
    <div class="messages">
      <%= render partial: "portal/message", collection: @messages, as: :message %>
    </div>
  <% end %>

  <h3 class="mt-4">Send us a message</h3>
  <%= form_with url: job_conversation_path(@job),
                scope: :message,
                local: true do |f| %>
    <div class="field mb-2">
      <%= f.text_area :body,
                      placeholder: "Type your message…",
                      rows: 3,
                      class: "form-control" %>
    </div>
    <div class="actions">
      <%= f.submit "Send", class: "btn btn-primary" %>
    </div>
  <% end %>

  <p class="mt-4">
    <%= link_to "← Dashboard", dashboard_path, class: "view-link" %>
  </p>
</div>
