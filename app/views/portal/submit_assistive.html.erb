<main class="container my-5">
  <h1 class="mb-4">Free 3D Assistive Devices Request</h1>
  <p class="help-text">You are welcome to request up to TWO (2) free 3D printed assistive devices per month. You will be notified by your chosen contact method when your items are ready to pick up. Please note that your request will be put in the queue with other patrons requests. It can take up to 2 weeks to be notified your devices are ready for pick up.</p>

  <%= form_tag submit_assistive_path,
        multipart: true,
        local: true,
        data: { turbo: false } do %>

    <!-- Name -->
    <div class="card mb-4">
      <div class="card-header"><h4 class="mb-0">Name</h4></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <%= label_tag 'patron[first_name]', 'First Name', class: 'form-label' %>
            <%= text_field_tag 'patron[first_name]',
                  params.dig(:patron, :first_name),
                  id: 'patron_first_name',
                  class: 'form-control',
                  required: true %>
          </div>
          <div class="col-md-6">
            <%= label_tag 'patron[last_name]', 'Last Name', class: 'form-label' %>
            <%= text_field_tag 'patron[last_name]',
                  params.dig(:patron, :last_name),
                  id: 'patron_last_name',
                  class: 'form-control',
                  required: true %>
          </div>
        </div>
        <div class="mt-3">
          <%= label_tag 'patron[email]', 'Email Address', class: 'form-label' %>
          <%= email_field_tag 'patron[email]',
                params.dig(:patron, :email),
                id: 'patron_email',
                class: 'form-control',
                required: true %>
        </div>
      </div>
    </div>

    <!-- Device Model -->
    <style>
      .device-option {
        flex: 0 0 calc(33.333% - 1rem);
        border: 2px solid transparent;
        border-radius: 0.5rem;
        padding: 0.75rem;
        cursor: pointer;
        text-align: center;
        margin-bottom: 1rem;
      }
      .device-option.selected {
        border-color: #2563eb;
      }
      .device-option img {
        display: block;
        margin: 0 auto 0.75rem;
        max-width: 100%;
        height: auto;
      }
      /* wrap container to allow flex items to flow */
      .device-container {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
    </style>

    <div class="card mb-4">
      <div class="card-header"><h4 class="mb-0">Device</h4></div>
      <div class="card-body">
        <div class="device-container">
          <% @printable_models.each do |pm| %>
            <div class="device-option" data-radio-id="job_printable_model_<%= pm.code %>">
              <%= radio_button_tag 'job[printable_model_id]',
                    pm.id,
                    params.dig(:job, :printable_model_id).to_s == pm.id.to_s,
                    id: "job_printable_model_#{pm.code}",
                    class: 'd-none',
                    required: true %>

              <label for="job_printable_model_<%= pm.code %>" class="d-block mb-2">
                <strong><%= pm.name %></strong>
              </label>

              <% if pm.preview_image.attached? %>
                <%= image_tag pm.preview_image.variant(resize_to_limit: [300, 300]),
                      alt: pm.name,
                      class: 'img-thumbnail' %>
              <% end %>

              <% if pm.notes.present? %>
                <p class="small text-muted mt-2"><%= pm.notes %></p>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('turbo:load', () => {
        const options = document.querySelectorAll('.device-option');
        function selectOption(radio) {
          options.forEach(o => o.classList.remove('selected'));
          const container = document.querySelector(`[data-radio-id="${radio.id}"]`);
          if (container) container.classList.add('selected');
        }
        options.forEach(option => {
          const radio = document.getElementById(option.dataset.radioId);
          if (radio.checked) selectOption(radio);
          option.addEventListener('click', () => {
            radio.checked = true;
            selectOption(radio);
          });
          radio.addEventListener('change', () => selectOption(radio));
        });
      });
    </script>

    <!-- Filament Color -->
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">Color</h4>
      </div>
      <div class="card-body">
        <%= label_tag 'job[filament_color]', 'Pick what color you would like your item to be', class: 'form-label' %>
        <%= select_tag 'job[filament_color]',
              options_from_collection_for_select(
                FilamentColor.all.order(:position),    # or scope down if needed
                :code, :name,
                params.dig(:job, :filament_color)
              ),
              include_blank: 'Select color',
              id: 'job_filament_color',
              class: 'form-select',
              required: true %>
      </div>
    </div>

    <!-- Preferred Contact -->
    <div class="card mb-4">
      <div class="card-header">
        <h4 class="mb-0">Preferred Contact</h4>
      </div>
      <div class="card-body">
        <%= label_tag 'job[notes]', 'How should we contact you?', class: 'form-label' %>
        <%= text_area_tag 'job[notes]',
              params.dig(:job, :notes),
              id: 'job_notes',
              rows: 4,
              placeholder: 'Your preferred contact methodâ€¦',
              class: 'form-control' %>
        <span class="help-text">
          If you would prefer to be contacted by phone, please enter your phone number here.
        </span>
      </div>
    </div>

    <!-- Pickup Location -->
    <div class="card mb-4">
      <div class="card-header"><h4 class="mb-0">Pickup Location</h4></div>
      <div class="card-body">
        <%= label_tag 'job[pickup_location]', 'Where will you pick up your print?', class: 'form-label' %>
        <%= select_tag 'job[pickup_location]',
              options_for_select(
                PickupLocation.active.order(:position).pluck(:name, :code),
                params.dig(:job, :pickup_location) || 'wood'
              ),
              id: 'job_pickup_location',
              class: 'form-select',
              required: true %>
        <span class="help-text">
          Only locations with active printers are available for pickup.
        </span>
      </div>
    </div>

    <!-- CAPTCHA -->
    <div class="card mb-4">
      <div class="card-header"><h4 class="mb-0">CAPTCHA</h4></div>
      <div class="card-body">
        <%= recaptcha_tags %>
        <% if @job&.errors&.[](:recaptcha).present? %>
          <div class="text-danger small mt-1">
            <%= @job.errors[:recaptcha].join(", ") %>
          </div>
        <% end %>
        <span class="help-text">
          Help us prevent spam.
        </span>
      </div>
    </div>

    <!-- Submit -->
    <div class="text-end">
      <%= submit_tag 'Submit Assistive Request', class: 'btn btn-primary btn-lg' %>
    </div>

    <p class="form-text text-muted mt-4">
      After we receive your request, we'll follow up within 48 hours (usually sooner) with print time, filament usage, cost, or any questions.
    </p>
  <% end %>
</main>
